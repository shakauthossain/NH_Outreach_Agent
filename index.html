
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leads Table</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    h2 {
      margin-bottom: 10px;
    }
    input, button, select {
      margin: 5px 10px 15px 0;
      padding: 8px;
      font-size: 14px;
    }
    input[type="text"], select {
      width: 250px;
    }
    button {
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    .score-green {
      color: green;
    }
    .score-red {
      color: red;
    }
    .mail-status-sent {
      color: green;
      font-weight: bold;
    }
    .mail-status-none {
      color: red;
      font-weight: bold;
    }
    a {
      color: blue;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h2>Saved Leads</h2>
  <div>
    <input type="text" id="industryInput" placeholder="Industry (e.g., Software)">
    <input type="text" id="functionInput" placeholder="Function (e.g., Marketing)">
    <input type="text" id="seniorityInput" placeholder="Seniority (e.g., VP)">
    <select id="perPageSelect">
      <option value="10" selected>10 Leads</option>
      <option value="25">25 Leads</option>
      <option value="50">50 Leads</option>
      <option value="100">100 Leads</option>
    </select>
    <button onclick="fetchNewLeads()">Fetch New Leads</button>
    <input type="text" id="searchInput" placeholder="🔍 Filter table..." onkeyup="filterTable()">
  </div>
  <span id="statusMsg"></span>
  <div>
    <button id="testAllBtn" onclick="testAllWebsites()">Test All Websites Speed</button>
  </div>
  <table id="leadsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Title</th>
        <th>Company</th>
        <th>Website</th>
        <th>LinkedIn</th>
        <th>Website Speed</th>
        <th>Screenshot</th>
        <th>Mail Panel</th>
        <th>Mail Status</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
  <script>
    const BASE_URL = "https://notionhive-ai-nh-outreach-agent.hf.space";
    async function loadLeads() {
      document.getElementById("tableBody").innerHTML = "";
      const res = await fetch(`${BASE_URL}/leads`);
      const data = await res.json();
      data.sort((a, b) => a.id - b.id);
      data.forEach((lead) => {
        const isGood = lead.website_speed_web && lead.website_speed_web > 80;
        const webSpeed = lead.website_speed_web != null ? lead.website_speed_web : 'No Speed Test Yet';
        const mobSpeed = lead.website_speed_mobile != null ? lead.website_speed_mobile : 'No Speed Test Yet';
        const mailStatus = lead.mail_sent ? "Mail Sent" : "No Mail";
        const mailClass = lead.mail_sent ? "mail-status-sent" : "mail-status-none";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${lead.id}</td>
          <td>${lead.first_name} ${lead.last_name}</td>
          <td>${lead.email.includes("locked_") ? "Locked" : lead.email}</td>
          <td>${lead.title || 'N/A'}</td>
          <td>${lead.company}</td>
          <td>${lead.website_url ? `<a href="${lead.website_url}" target="_blank">Visit</a>` : "No website link"}</td>
          <td><a href="${lead.linkedin_url || '#'}" target="_blank">${lead.linkedin_url ? 'LinkedIn' : 'N/A'}</a></td>
          <td class="${isGood ? 'score-green' : 'score-red'}">${webSpeed} / ${mobSpeed}<br><button id="refreshBtn-${lead.id}" onclick="refreshSpeed(${lead.id})">Refresh Speed</button>
          <td>${lead.screenshot_url ? `<a href="${lead.screenshot_url}" target="_blank">View</a>` : "N/A"}</td>
          <td><a href="https://notionhive-ai-nh-outreach-agent.hf.space/mail/${lead.id}" target="_blank">Open Mail Panel</a></td>
          <td class="${mailClass}">${mailStatus}</td>
        `;
        document.getElementById("tableBody").appendChild(row);
      });
    }
    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#tableBody tr");
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
      });
    }
    async function fetchNewLeads() {
      const industry = document.getElementById("industryInput").value.trim();
      const functions = document.getElementById("functionInput").value.trim();
      const seniority = document.getElementById("seniorityInput").value.trim();
      const perPage = document.getElementById("perPageSelect").value;
      const params = new URLSearchParams();
      if (industry) params.append("industry", industry);
      if (functions) params.append("functions", functions);
      if (seniority) params.append("seniority", seniority);
      params.append("per_page", perPage);
      const button = event.target;
      const status = document.getElementById("statusMsg");
      button.disabled = true;
      status.textContent = "Fetching new leads...";
      try {
        await fetch(`${BASE_URL}/import/apollo?${params.toString()}`);
        status.textContent = `Fetched leads for search.`;
        await loadLeads();
      } catch (err) {
        console.error("Error:", err);
        status.textContent = "❌ Failed to fetch.";
      }
      button.disabled = false;
    }
    async function refreshSpeed(leadId) {
      const status = document.getElementById("statusMsg");
      const button = document.getElementById(`refreshBtn-${leadId}`);
      if (!button) {
        console.warn(`No refresh button found for leadId: ${leadId}`);
        return;
      }
      button.disabled = true;
      button.innerHTML = "Loading...";
      status.textContent = `Refreshing speed for lead ${leadId}...`;
      try {
        const res = await fetch(`${BASE_URL}/speedtest/${leadId}`, { method: "POST" });
        const data = await res.json();
        status.textContent = data.message || data.error || "Unknown error.";
        await loadLeads();
      } catch (err) {
        console.error("Error:", err);
        status.textContent = "Failed to refresh speed.";
      }
      button.innerHTML = "Refresh Speed";
      button.disabled = false;
    }
    async function testAllWebsites() {
      const status = document.getElementById("statusMsg");
      const button = document.getElementById("testAllBtn");
      button.disabled = true;
      status.textContent = "Testing all websites' speeds...";
      try {
        const res = await fetch(`${BASE_URL}/speedtest`, { method: "POST" });
        const data = await res.json();
        status.textContent = data.message;
        await loadLeads();
      } catch (err) {
        console.error("Error:", err);
        status.textContent = "Failed to test all websites' speeds.";
      }
      button.disabled = false;
    }
    let currentPage = 0;
    let totalLoaded = 0;
    let PAGE_SIZE = parseInt(document.getElementById("perPageSelect").value);

    document.getElementById("perPageSelect").addEventListener("change", () => {
      PAGE_SIZE = parseInt(document.getElementById("perPageSelect").value);
      currentPage = 0;
      loadLeads();
    });

    async function loadLeads() {
      document.getElementById("tableBody").innerHTML = "";
      const res = await fetch(`${BASE_URL}/leads?skip=${currentPage * PAGE_SIZE}&limit=${PAGE_SIZE}`);
      const data = await res.json();
      totalLoaded = data.length;

      data.forEach((lead) => {
        const isGood = lead.website_speed_web && lead.website_speed_web > 80;
        const webSpeed = lead.website_speed_web != null ? lead.website_speed_web : 'No Speed Test Yet';
        const mobSpeed = lead.website_speed_mobile != null ? lead.website_speed_mobile : 'No Speed Test Yet';
        const mailStatus = lead.mail_sent ? "Mail Sent" : "No Mail";
        const mailClass = lead.mail_sent ? "mail-status-sent" : "mail-status-none";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${lead.id}</td>
          <td>${lead.first_name} ${lead.last_name}</td>
          <td>${lead.email.includes("locked_") ? "Locked" : lead.email}</td>
          <td>${lead.title || 'N/A'}</td>
          <td>${lead.company}</td>
          <td>${lead.website_url ? `<a href="${lead.website_url}" target="_blank">Visit</a>` : "No website link"}</td>
          <td><a href="${lead.linkedin_url || '#'}" target="_blank">${lead.linkedin_url ? 'LinkedIn' : 'N/A'}</a></td>
          <td class="${isGood ? 'score-green' : 'score-red'}">${webSpeed} / ${mobSpeed}<br><button id="refreshBtn-${lead.id}" onclick="refreshSpeed(${lead.id})">Refresh Speed</button></td>
          <td>${lead.screenshot_url ? `<a href="${lead.screenshot_url}" target="_blank">View</a>` : "N/A"}</td>
          <td><a href="https://notionhive-ai-nh-outreach-agent.hf.space/mail/${lead.id}" target="_blank">Open Mail Panel</a></td>
          <td class="${mailClass}">${mailStatus}</td>
        `;
        document.getElementById("tableBody").appendChild(row);
      });
      renderPagination();
    }

    function renderPagination() {
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      const totalPages = totalLoaded < PAGE_SIZE ? currentPage + 1 : currentPage + 2;
      const fragment = document.createDocumentFragment();

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Prev";
      prevBtn.disabled = currentPage === 0;
      prevBtn.onclick = () => {
        currentPage--;
        loadLeads();
      };
      fragment.appendChild(prevBtn);

      for (let i = 0; i < totalPages; i++) {
        const pageBtn = document.createElement("button");
        pageBtn.textContent = i + 1;
        pageBtn.style.margin = "0 3px";
        if (i === currentPage) {
          pageBtn.style.backgroundColor = "#ffffff";
          pageBtn.style.color = "black";
          pageBtn.style.fontWeight = "bold";
          pageBtn.style.border = "1px solid black";
        }
        pageBtn.onclick = () => {
          currentPage = i;
          loadLeads();
        };
        fragment.appendChild(pageBtn);
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.disabled = totalLoaded < PAGE_SIZE;
      nextBtn.onclick = () => {
        currentPage++;
        loadLeads();
      };
      fragment.appendChild(nextBtn);
      container.appendChild(fragment);
    }
    window.onload = loadLeads;
  </script>
</body>
</html>